// Function to connect to the database
function connectToDatabase() {
  return new Promise((resolve, reject) => {
    var mysql = require('mysql');
    var con = mysql.createConnection({
      host: "localhost",
      user: "root",
      password: "",
      database: "grab_and_go"
    });

    con.connect(function(err) {
      if (err) {
        reject(err);
      } else {
        console.log("Connected!");
        resolve(con);
      }
    });
  });
}

//test of query to databse to INSERT data
// function insertDataIntoDatabase(con){
//   var sql = "INSERT INTO job_orders (job_number, date_ordered, company_name) VALUES ('Test_1','30/01/24','Company Inc')";
//   con.query(sql, function (err, result) {
//     if (err) throw err;
//     console.log("1 record inserted");
//   });
// }

//  //test of query to DELETE data
//  function deleteDataFromDatabase(con){
//   var sql = "DELETE FROM job_orders WHERE company_name = 'Company Inc'";
//     con.query(sql, function (err, result) {
//     if (err) throw err;
//     console.log("Number of records deleted: " + result.affectedRows);
//   });
// }

// Function to fetch data from the database
function fetchDataFromDatabase(con) {
  return new Promise((resolve, reject) => {
    var sql = "SELECT date_ordered FROM job_orders WHERE job_number='Test_1';";
    con.query(sql, function (err, result, fields) {
      if (err) {
        reject(err);
      } else {
        // Process the results
        const dateOrderedArray = result.map(row => row.date_ordered);
        resolve(dateOrderedArray);

         // Process the results ALT
        for (const row of result) {
        date_Ordered = row.date_ordered;
        console.log(date_Ordered);
      }
      }
    });
  });
}

// Function to create a JSON object
function createJSONObject(dateOrderedArray) {
  return new Promise((resolve, reject) => {
    // Access the first element of the array (assuming there's only one result)
    const dateOrdered = dateOrderedArray[0];

    // packing slip JSON object created
    const packingSlip = {
      "dateOrdered": dateOrdered
    };

    resolve(packingSlip);
  });
}

// Usage of the functions with async/await
async function main() {
  try {
    const con = await connectToDatabase();
    const dateOrderedArray = await fetchDataFromDatabase(con);
    const packingSlip = await createJSONObject(dateOrderedArray);

    // Accessing for a particular detail from the object packingSlip
    const i = packingSlip.dateOrdered;

    // It prints the detail of the date ordered
    console.log("Printing test for JSON object: " + i);

    // Close the database connection
    con.end();
  } catch (error) {
    console.error('Error:', error);
  }
}

// Run the main function
main();